<% include ../layout/header %>

<div id="client">

    <div id="alert-error" class="alert alert-danger alert-dismissible error-block" role="alert">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                    aria-hidden="true">&times;</span></button>
        <span class="message"></span>
    </div>

    <div id="alert-success" class="alert alert-success alert-dismissible error-block" role="alert">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                    aria-hidden="true">&times;</span></button>
        <span class="message"></span>
    </div>

    <h1><%= __('ADMIN_CLIENT_PAGE_TITLE') %></h1>

    <div class="table-responsive" id="clientsTable">
        <table class="table table-striped">
            <thead>
            <tr>
                <th><%= __('ADMIN_CLIENT_NAME_TABLE_COL_TITLE') %></th>
                <th><%= __('ADMIN_CLIENT_CLIENT_ID_TABLE_COL_TITLE') %></th>
                <th><%= __('ADMIN_CLIENT_REDIRECT_URI_TABLE_COL_TITLE') %></th>
                <th><%= __('ADMIN_CLIENT_ACTIONS_TABLE_COL_TITLE') %></th>
            </tr>
            </thead>
            <tbody id="clientsTableTbody">

            </tbody>
        </table>
    </div>

    <p>
        <button class="btn-link" data-toggle="modal"
                data-target="#addClientModal"><%= __('ADMIN_CLIENT_ADD_A_CLIENT_LINK') %></button>
    </p>

</div>

<!-- Add client Modal -->
<div class="modal fade" id="addClientModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel"><%= __('ADMIN_CLIENT_ADD_CLIENT_MODALE_TITLE') %></h4>
            </div>
            <div class="modal-body">
                <form id="addClientForm">
                    <div class="form-group">
                        <label for="name"><%= __('ADMIN_CLIENT_ADD_CLIENT_MODALE_FORM_NAME') %></label>
                        <input type="text" class="form-control" id="name"
                               placeholder="<%= __('ADMIN_CLIENT_ADD_CLIENT_MODALE_FORM_NAME') %>">
                    </div>
                    <div class="form-group">
                        <label for="clientID"><%= __('ADMIN_CLIENT_ADD_CLIENT_MODALE_FORM_ID') %></label>
                        <input type="text" class="form-control" id="clientID"
                               placeholder="<%= __('ADMIN_CLIENT_ADD_CLIENT_MODALE_FORM_ID') %>">
                    </div>
                    <div class="form-group">
                        <label for="redirectURI"><%= __('ADMIN_CLIENT_ADD_CLIENT_MODALE_FORM_REDIRECT_URI') %></label>
                        <input type="text" class="form-control" id="redirectURI"
                               placeholder="<%= __('ADMIN_CLIENT_ADD_CLIENT_MODALE_FORM_REDIRECT_URI') %>">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default"
                        data-dismiss="modal"><%= __('ADMIN_CLIENT_ADD_CLIENT_MODALE_CLOSE') %></button>
                <button id="add-client" type="button"
                        class="btn btn-primary"><%= __('ADMIN_CLIENT_ADD_CLIENT_MODALE_SUBMIT') %></button>
            </div>
        </div>
    </div>
</div>

<!-- Update client Modal -->
<div class="modal fade" id="updateClientModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel"><%= __('ADMIN_CLIENT_UPDATE_CLIENT_MODALE_TITLE') %></h4>
            </div>
            <div class="modal-body">
                <form id="addClientForm">
                    <div class="form-group">
                        <label for="name"><%= __('ADMIN_CLIENT_ADD_CLIENT_MODALE_FORM_NAME') %></label>
                        <input type="text" class="form-control" id="update-name"
                               placeholder="<%= __('ADMIN_CLIENT_ADD_CLIENT_MODALE_FORM_NAME') %>">
                    </div>
                    <div class="form-group">
                        <label for="clientID"><%= __('ADMIN_CLIENT_ADD_CLIENT_MODALE_FORM_ID') %></label>
                        <input type="text" class="form-control" id="update-clientID"
                               placeholder="<%= __('ADMIN_CLIENT_ADD_CLIENT_MODALE_FORM_ID') %>">
                    </div>
                    <div class="form-group">
                        <label for="redirectURI"><%= __('ADMIN_CLIENT_ADD_CLIENT_MODALE_FORM_REDIRECT_URI') %></label>
                        <input type="text" class="form-control" id="update-redirectURI"
                               placeholder="<%= __('ADMIN_CLIENT_ADD_CLIENT_MODALE_FORM_REDIRECT_URI') %>">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default"
                        data-dismiss="modal"><%= __('ADMIN_CLIENT_ADD_CLIENT_MODALE_CLOSE') %></button>
                <button id="update-client" type="button"
                        class="btn btn-primary"><%= __('ADMIN_CLIENT_UPDATE_CLIENT_MODALE_SUBMIT') %></button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

    var eventListeners = function () {
    };


    (function () {
        var $alertError = $('#alert-error');
        var $alertSuccess = $('#alert-success');
        var $errorMessage = $('#alert-error .message');
        var $successMessage = $('#alert-success .message');
        var $addClientModal = $('#addClientModal');

        $( document ).ready(function() {
            displayList();
        });

        eventListeners = function () {
            $('.delete-client').on('click', function (event) {
                refreshMessages();
                var realId = getRealId(this);
                $.ajax({
                    url: '/api/admin/clients/' + encodeURIComponent(realId),
                    method: 'DELETE'
                }).then(
                    function (data, status, jqXHR) {
                        $successMessage.append("<%= __('ADMIN_CLIENT_MESSAGE_DELETE_CLIENT_SUCCESS') %>");
                        $alertSuccess.show();
                        displayList();
                    },
                    function (jqXHR, status, error) {
                        console.log(error);
                        $errorMessage.append("<%= __('ADMIN_CLIENT_MESSAGE_DELETE_CLIENT_FAIL') %>");
                        $alertError.show();
                    }
                );
            });
            $('.refresh-secret').on('click', function (event) {
                refreshMessages();
                var realId = getRealId(this);
                $.ajax('/api/admin/clients/' + encodeURIComponent(realId) + '/secret').then(
                    function (data, status, jqXHR) {
                        console.log(data);
                        $successMessage.append("<%= __('ADMIN_CLIENT_MESSAGE_REFRESH_SECRET_SUCCESS') %> ", data.secret);
                        $alertSuccess.show();
                    },
                    function (jqXHR, status, error) {
                        console.log(error);
                        $errorMessage.append("<%= __('ADMIN_CLIENT_MESSAGE_REFRESH_SECRET_FAIL') %> ");
                        $alertError.show();
                    }
                );
            });
        };

        eventListeners();

        $('#add-client').on('click', function (event) {
            refreshMessages();

            var $dialog = $('#addClientModal');
            var name = $dialog.find('#name').val();
            var clientId = $dialog.find('#clientID').val();
            var redirectUri = $dialog.find('#redirectURI').val();

            $.ajax({
                url: '/api/admin/clients',
                method: 'POST',
                data: {name: name, client_id: clientId, redirect_uri: redirectUri}
            }).then(
                function (data, status, jqXHR) {
                    console.log(data);
                    $successMessage.append("<%= __('ADMIN_CLIENT_MESSAGE_ADD_CLIENT_SUCCESS') %>", data.secret);
                    $alertSuccess.show();
                    $addClientModal.modal('toggle');
                    displayList();
                },
                function (jqXHR, status, error) {
                    console.log(error);
                    $errorMessage.append("<%= __('ADMIN_CLIENT_MESSAGE_ADD_CLIENT_FAIL', {secret: 'mon secret qui ne marche pas'}) %>");
                    $alertError.show();
                    $addClientModal.modal('toggle');
                }
            );
        });

        $('#update-client').on('click', function (event) {
            refreshMessages();
            var $dialog = $('#updateClientModal');

            $dialog.modal('toggle');

            $successMessage.append("<%= __('ADMIN_CLIENT_MESSAGE_EDIT_CLIENT_SUCCESS') %>");
            $alertSuccess.show();
            $errorMessage.append("<%= __('ADMIN_CLIENT_MESSAGE_EDIT_CLIENT_FAIL') %>");
            $alertError.show();
        });

        refreshMessages = function () {
            $successMessage.html('');
            $errorMessage.html('');
            $alertError.hide();
            $alertSuccess.hide();
        }

        var displayList = function () {
            $.ajax({
                url: '/api/admin/clients/',
                method: 'GET'
            }).then(
                function (data, status, jqXHR) {
                    //$("#clientsTable > tbody").html("");
                    $("#clientsTable").find("tr:gt(0)").remove();
                    for (var i = 0; i < data.length; i++) {
                        $('#clientsTable tr:last').after(buildRow(data[i].id, data[i].name, data[i].client_id, data[i].redirect_uri));
                    }
                    eventListeners();
                },
                function (jqXHR, status, error) {
                    console.log(error);
                    $errorMessage.append("<%= __('ADMIN_CLIENT_ERROR_CANNOT_LOAD_CLIENT_LIST') %>");
                    $alertError.show();
                }
            );
        }

        var buildRow = function (id, name, client_id, redirect_uri) {
            var edit = "<%= __('ADMIN_CLIENT_ACTIONS_EDIT_CLIENT') %>";
            var del = "<%= __('ADMIN_CLIENT_ACTIONS_DELETE_CLIENT') %>";
            var reg = "<%= __('ADMIN_CLIENT_ACTIONS_REGENERATE_CLIENT_SECRET') %>";

            var row = '';
            row = row + '            <tr>\n';
            row = row + '                <td class="client-name">' + name + '</td>\n';
            row = row + '                <td class="client-id">' + client_id + '</td>\n';
            row = row + '                <td class="client-redirect">' + redirect_uri + '</td>\n';
            row = row + '                <td>\n';
            row = row + '                    <span class="hidden real-id">' + id + '</span>\n';
            row = row + '                    <div class="btn-toolbar" role="toolbar">\n';
            row = row + '                        <div class="btn-group">\n';
            row = row + '                            <button type="button" class="btn btn-default edit-client" data-toggle="modal" data-target="#updateClientModal" aria-label="' + edit + '" title="' + edit + '">\n';
            row = row + '                                <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>\n';
            row = row + '                            </button>\n';
            row = row + '                            <button type="button" class="btn btn-default delete-client" aria-label="' + del + '" title="' + del + '">\n';
            row = row + '                                <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>\n';
            row = row + '                            </button>\n';
            row = row + '                            <button type="button" class="btn btn-default refresh-secret" aria-label="' + reg + '" title="' + reg + '">\n';
            row = row + '                                <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>\n';
            row = row + '                            </button>\n';
            row = row + '                        </div>\n';
            row = row + '                    </div>\n';
            row = row + '                </td>\n';
            row = row + '            </tr>\n';

            return row;
        }

        function getRealId(target) {
            var row = $(target).closest('tr');
            var cell = row.find('.real-id');
            return cell.text();
        }
    })();
</script>

<% include ../layout/foot %>
