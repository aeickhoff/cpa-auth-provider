<!DOCTYPE html>
<html>
<head>
    <title>Demo OAuth2 Client: Implicit</title>
    <!-- Bootstrap -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body style="background-color:#eee;">

<a href="/">&lt;&lt; flow selection</a>
<div class="container">
    <h1>OAuth 2 Client: Implicit</h1>

    <a href="<%= loginUrl %>" class="btn btn-info hide" id="login-btn">Login implicit</a>
    <a href="#logout" class="btn btn-warning hide" id="logout-btn">Logout implicit</a>

    <div id="user-widget" style="margin: 20px 0 5px;"></div>

    <script>
		(function () {
			// fail if we can't use local storage
			if (typeof(Storage) === 'undefined') {
				throw "NotImplementedError";
			}

			var TOKEN_STORAGE = 'cpa:token';

			$(function () {
				loadProfile(
					function (user) {
						if (user) {
							loadInterface(user);
						} else {
							$('#login-btn').removeClass('hide');
						}
					}
				);
			});

			// parse url to get token as sent from callback
			function extractToken() {
				var hash = location.hash.substr(1);
				var token = hash.substr(hash.indexOf('access_token=')).split('&')[0].split('=')[1];
				return token;
			}

			function loadInterface(user) {
				$('#user-widget').html('You are logged in as: ' + user.name);
				$('#logout-btn').removeClass('hide').click(function () {
					removeToken();
					location.reload();
				});
			}

			function loadProfile(done) {
				var token = extractToken();
				if (token) {
					storeToken(token);
				} else {
					token = getToken(token);
				}

				if (token) {
					return callServer(token, done);
				} else {
					return done();
				}
			}

			function callServer(token, done) {
				jQuery.ajax(
					{
						url: "<%= profileUrl %>",
						type: "GET",
						headers: {
							"Authorization": "Bearer " + token,
							"Content-Type": "application/x-www-form-urlencoded",
						},
					}
				).done(
					function (data, textStatus, jqXHR) {
						console.log("HTTP Request Succeeded: " + jqXHR.status);
						console.log(data);
						return done(data.user);
					}
				).fail(
					function (jqXHR, textStatus, errorThrown) {
						console.log("HTTP Request Failed");
						return done();
					}
				);
			}

			function storeToken(token) {
				localStorage.setItem(TOKEN_STORAGE, token);
			}

			function getToken() {
				return localStorage.getItem(TOKEN_STORAGE);
			}

			function removeToken() {
				return localStorage.removeItem(TOKEN_STORAGE);
			}
		})();
    </script>
</div>
</body>
</html>
