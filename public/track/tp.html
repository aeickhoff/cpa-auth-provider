<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tracking Provider</title>
</head>
<body>
    <!-- should be invisible -->
    <script>
        (function() {
            var path = '';
            window.onload = function() {
                if (window.parent) {
                    window.parent.postMessage({e: 'tp-ready', k: ''}, '*');
                }
            };

            window.addEventListener('message', receiveMessage, false);

            function receiveMessage(event) {
                var request, segments;
                var origin = event.origin || event.originalEvent.origin;

                var type = event.data.e;
                var replyIdentifier = event.data.k;
                if (type === 'request-uid') {
                    makeHttpRequest(path + 'device/request_uid', {}, requestUidListener());
                } else {
                    console.log('received unrecognized event:', event.data);
                }

                function makeHttpRequest(address, fields, callback) {
                    var request = new XMLHttpRequest();

                    request.addEventListener('load', callback);
                    request.open('POST', address);
                    request.setRequestHeader('X-TP-Origin', origin);
                    request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');

                    segments = [];
                    for (var key in fields) {
                        if (fields.hasOwnProperty(key)) {
                            segments.push(key + '=' + encodeURIComponent(fields[key]));
                        }
                    }
                    request.send(segments.join('&'));
                }

                function requestUidListener() {
                    console.log(this.response);

                    var data = JSON.parse(this.response);
                    var uid = data.uid;
                    event.source.postMessage(
                            {
                                e: 'uid-reply',
                                k: replyIdentifier,
                                uid: uid
                            }, origin);
                }

            }
        })();
    </script>
</body>
</html>